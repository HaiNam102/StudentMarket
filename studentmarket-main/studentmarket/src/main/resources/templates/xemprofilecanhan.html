<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Market - Website trao đổi và mua bán đồ dùng cũ dành cho sinh viên DTU</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">
    <!-- Overlay nền mờ -->
    <div id="overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40"></div>

    <!-- Header (auto-switch) -->
    <div sec:authorize="isAuthenticated()" th:replace="~{fragments/headerUSER :: headerUSER}"></div>
    <div sec:authorize="!isAuthenticated()" th:replace="~{fragments/headerGUEST :: headerGUEST}"></div>

    <main class=" pt-14">

        <!-- BREADCRUMB -->
        <nav class="max-w-7xl mx-auto px-4 p-2 text-[13px] text-gray-600">
            <ol class="flex items-center gap-1.5 flex-wrap">
                <li>
                    <i class="fa-solid fa-house"></i>
                    <a th:href="@{/StudentMarket}" class="hover:underline">Trang chủ</a>
                </li>
                <li class="text-gray-400">/</li>
                <li class="truncate max-w-[40vw] text-gray-900 font-semibold">Trang cá nhân của <span
                        th:text="${target != null ? target.fullName : 'Người dùng'}">Người dùng</span>
                </li>
            </ol>
        </nav>

        <!-- ========== TRANG CÁ NHÂN ========== -->
        <section class="max-w-7xl mx-auto px-4">
            <div class="grid grid-cols-1 lg:grid-cols-[300px,1fr] gap-4 items-start mb-10">

                <!-- SIDEBAR TRÁI -->
                <aside class="relative bg-white rounded-2xl shadow border border-gray-200">

                    <!-- Đang hoạt động góc phải trên -->
                    <div class="js-live-status absolute top-3 left-3 text-xs text-gray-600 flex items-center gap-1"
                        th:attr="data-user-id=${target.userId},
              data-last-seen=${target.lastSeenAt != null ? #temporals.format(target.lastSeenAt, 'yyyy-MM-dd''T''HH:mm:ss') : ''}">
                        <span class="js-dot inline-block w-2 h-2 rounded-full"
                            th:classappend="${isOnline} ? ' bg-green-500' : ' bg-gray-400'"></span>
                        <span class="js-text" th:text="${isOnline} ? 'Đang hoạt động' : ${lastSeenHuman}">Đang hoạt
                            động</span>
                    </div>
                    <!-- JS trạng thái hoạt động (poller dùng chung cho mọi widget trên trang) -->
                    <script>
                        (function () {
                            if (window._liveStatusPoller) return;         // tránh init trùng
                            window._liveStatusPoller = true;

                            const ONLINE_WINDOW_SEC = 60;
                            const pad = n => String(n).padStart(2, '0');

                            function renderFromIso(box, iso) {
                                const dot = box.querySelector('.js-dot');
                                const text = box.querySelector('.js-text');
                                if (!dot || !text) return;

                                if (!iso) {
                                    dot.classList.remove('bg-green-500'); dot.classList.add('bg-gray-400');
                                    text.textContent = 'Chưa từng hoạt động';
                                    return;
                                }
                                const last = new Date(iso);
                                const diffSec = Math.floor((Date.now() - last.getTime()) / 1000);
                                const online = diffSec < ONLINE_WINDOW_SEC;

                                dot.classList.toggle('bg-green-500', online);
                                dot.classList.toggle('bg-gray-400', !online);

                                if (online) { text.textContent = 'Đang hoạt động'; return; }

                                const m = Math.floor(diffSec / 60);
                                if (m < 60) { text.textContent = `Hoạt động ${m} phút trước`; return; }
                                const h = Math.floor(m / 60);
                                if (h < 24) { text.textContent = `Hoạt động ${h} giờ trước`; return; }
                                text.textContent =
                                    `Hoạt động ${pad(last.getDate())}/${pad(last.getMonth() + 1)}/${last.getFullYear()} ` +
                                    `${pad(last.getHours())}:${pad(last.getMinutes())}`;
                            }

                            async function updateAll() {
                                const boxes = Array.from(document.querySelectorAll('.js-live-status'));
                                if (!boxes.length) return;

                                // gom theo userId để fetch 1 lần/user
                                const byUser = new Map();
                                for (const box of boxes) {
                                    const uid = box.dataset.userId;
                                    if (!uid || uid === '0') continue;
                                    if (!byUser.has(uid)) byUser.set(uid, []);
                                    byUser.get(uid).push(box);
                                }

                                // fetch song song
                                const uids = Array.from(byUser.keys());
                                const results = await Promise.all(uids.map(uid =>
                                    fetch(`/api/users/${uid}/last-seen?t=${Date.now()}`, { cache: 'no-store' })
                                        .then(r => r.ok ? r.json() : null)
                                        .catch(() => null)
                                ));

                                // áp kết quả cho mọi box cùng userId
                                uids.forEach((uid, i) => {
                                    const iso = results[i] && results[i].lastSeenIso ? results[i].lastSeenIso : '';
                                    byUser.get(uid).forEach(box => {
                                        box.dataset.lastSeen = iso;
                                        renderFromIso(box, iso);
                                    });
                                });

                                // render nốt box không có userId (nếu có)
                                boxes.forEach(box => {
                                    if (!box.dataset.userId || box.dataset.userId === '0') {
                                        renderFromIso(box, box.dataset.lastSeen || '');
                                    }
                                });
                            }

                            // render ngay, rồi canh mép phút cho đồng bộ tuyệt đối
                            updateAll();
                            const skew = Date.now() % 60000;
                            setTimeout(() => {
                                updateAll();
                                setInterval(updateAll, 60_000);
                            }, 60_000 - skew);
                        })();
                    </script>

                    <!-- Nút ba chấm + menu hành động (chỉ sao chép) -->
                    <div id="profileActions" class="absolute top-3 right-3"
                        th:attr="data-profile-url=@{/StudentMarket/xemprofile/{id}(id=${target.userId})}">
                        <!-- Button ba chấm -->
                        <button id="btnActions" type="button"
                            class="w-8 h-8 grid place-items-center rounded-full bg-white/90 text-gray-700 border border-gray-200 shadow hover:bg-gray-100"
                            aria-haspopup="menu" aria-expanded="false" aria-controls="actionsMenu" title="Tùy chọn">
                            <i class="fa-solid fa-ellipsis-vertical"></i>
                        </button>

                        <!-- Dropdown chỉ có Sao chép -->
                        <div id="actionsMenu"
                            class="hidden absolute right-0 mt-2 w-56 bg-white text-gray-700 rounded-md shadow-lg border z-50 overflow-hidden"
                            role="menu" aria-labelledby="btnActions">
                            <button type="button" id="copyProfileLink" data-feedback-sec="1"
                                class="text-[14px] w-full px-4 py-2 text-left hover:bg-gray-100 flex items-center gap-2">
                                <i class="fa-solid fa-link w-4 text-gray-600"></i>
                                <span>Sao chép liên kết trang cá nhân</span>
                            </button>
                        </div>
                    </div>
                    <!-- JS dropdown 3 chấm góc phải profile-->
                    <script>
                        (function () {
                            const wrap = document.getElementById('profileActions');
                            if (!wrap) return;

                            const btn = document.getElementById('btnActions');
                            const menu = document.getElementById('actionsMenu');
                            const copyBtn = document.getElementById('copyProfileLink');

                            const profileUrl = wrap.getAttribute('data-profile-url') || window.location.href;

                            function closeMenu() {
                                menu.classList.add('hidden');
                                btn.setAttribute('aria-expanded', 'false');
                            }

                            function setDisabled(el, on) {
                                if (on) {
                                    el.setAttribute('disabled', '');
                                    el.setAttribute('aria-disabled', 'true');
                                    el.classList.add('pointer-events-none', 'opacity-60', 'cursor-not-allowed');
                                } else {
                                    el.removeAttribute('disabled');
                                    el.removeAttribute('aria-disabled');
                                    el.classList.remove('pointer-events-none', 'opacity-60', 'cursor-not-allowed');
                                }
                            }

                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const hidden = menu.classList.contains('hidden');
                                // đóng các menu khác (nếu có)
                                document.querySelectorAll('#actionsMenu').forEach(m => m.classList.add('hidden'));
                                if (hidden) {
                                    menu.classList.remove('hidden');
                                    btn.setAttribute('aria-expanded', 'true');
                                } else {
                                    closeMenu();
                                }
                            });

                            // chỉ đóng khi click ra ngoài vùng actions
                            document.addEventListener('click', (e) => {
                                if (!wrap.contains(e.target)) closeMenu();
                            });
                            document.addEventListener('keydown', (e) => {
                                if (e.key === 'Escape') closeMenu();
                            });

                            copyBtn.addEventListener('click', async (e) => {
                                e.stopPropagation(); // không đóng menu
                                const originalHTML = copyBtn.innerHTML;
                                const sec = parseFloat(copyBtn.getAttribute('data-feedback-sec') || '1.5');
                                const feedbackMs = Math.max(0, sec * 1000);

                                const showFeedback = (label, ms) => {
                                    setDisabled(copyBtn, true);
                                    copyBtn.innerHTML = `<i class="fa-solid fa-check w-4"></i><span>${label}</span>`;
                                    setTimeout(() => {
                                        copyBtn.innerHTML = originalHTML;
                                        setDisabled(copyBtn, false);
                                    }, ms);
                                };

                                try {
                                    const absolute = new URL(profileUrl, window.location.origin).href;
                                    if (navigator.clipboard?.writeText) {
                                        await navigator.clipboard.writeText(absolute);
                                    } else {
                                        const ta = document.createElement('textarea');
                                        ta.value = absolute;
                                        document.body.appendChild(ta);
                                        ta.select();
                                        document.execCommand('copy');
                                        ta.remove();
                                    }
                                    // Hiển thị "Đã sao chép" (không đếm giờ), disable trong thời gian cấu hình
                                    showFeedback('Đã sao chép', feedbackMs);
                                } catch (_) {
                                    // Thông báo lỗi ngắn (không đếm giờ)
                                    showFeedback('Lỗi sao chép', 1500);
                                }
                                // Không gọi closeMenu() để menu không tự ẩn
                            });
                        })();
                    </script>



                    <!-- Thông tin chính -->
                    <div class="flex flex-col items-center text-center px-10 pt-14">
                        <!-- Avatar giữa -->
                        <img th:src="${target != null && target.picture != null && !#strings.isEmpty(target.picture) 
              ? target.picture : '/image/header_user/avartar.jpg'}" class="w-20 h-20 rounded-full object-cover"
                            alt="Avatar" />

                        <p class="mt-2 font-semibold text-gray-900 text-lg flex items-center gap-1">
                            <span th:text="${target != null ? target.fullName : 'Người dùng'}">Người dùng</span>
                            <img src="/image/tichluydiem/b1.png" class="w-5 h-5" alt="badge">
                        </p>


                        <!-- Nút giữa -->
                        <div class="mt-3 flex items-center justify-center gap-2">
                            <a href="/thongtintaikhoan" onclick="sessionStorage.setItem('autoOpenEdit','1')"
                                class="px-3 py-1.5 rounded-full border text-sm font-medium text-red-600 border-red-500 hover:bg-red-50 inline-flex items-center gap-2">
                                <i class="fa-solid fa-pen"></i>
                                Chỉnh sửa thông tin
                            </a>
                        </div>
                    </div>

                    <!-- Gạch ngang full ngang card -->
                    <div class="w-full h-px bg-gray-200 my-4"></div>

                    <!-- Thông tin khác -->
                    <div class="px-6 pb-6">
                        <ul class="w-full space-y-4 text-sm">
                            <li class="flex items-start gap-2">
                                <i class="fa-solid fa-star mt-0.5 text-gray-500"></i>
                                <span>Đánh giá: <span class="text-red-600 font-semibold">4.7</span> (
                                    <a href="#" class="underline">14 Đánh giá</a> )
                                </span>
                            </li>

                            <li class="flex items-start gap-2">
                                <i class="fa-solid fa-users mt-0.5 text-gray-500"></i>
                                <span>Người theo dõi: <span class="font-semibold">18</span></span>
                            </li>

                            <li class="flex items-start gap-2">
                                <i class="fa-solid fa-user-check mt-0.5 text-gray-500"></i>
                                <span>Đang theo dõi: <span class="font-semibold">3</span></span>
                            </li>

                            <li class="flex items-start gap-2">
                                <i class="fa-solid fa-calendar-days mt-0.5 text-gray-500"></i>
                                <span>Ngày tham gia:
                                    <span class="font-semibold" th:text="${target != null && target.joinedAt != null 
                    ? #temporals.format(target.joinedAt, 'dd/MM/yyyy') 
                    : '—'}">13/09/2025</span>
                                </span>
                            </li>


                            <li class="flex items-start gap-2">
                                <i class="fa-solid fa-location-dot mt-0.5 text-gray-500"></i>
                                <span>Địa chỉ: <span class="text-red-600 font-semibold">Đà Nẵng</span></span>
                            </li>
                        </ul>


                    </div>
                </aside>

                <!-- KHUNG PHẢI -->
                <section class="bg-white rounded-2xl shadow border border-gray-200 p-3 lg:p-4 ">

                    <!-- TABS -->
                    <div class="w-full">
                        <div id="lsTabs"
                            class="grid grid-cols-2 text-sm font-semibold text-center border-b border-gray-200">
                            <button data-tab="da-dang" class="tab-btn py-3 border-b-2 border-red-500 text-red-600">
                                Đã đăng <span class="ml-1">(3)</span>
                            </button>
                            <button data-tab="da-ban" class="tab-btn py-3 border-b-2 border-transparent text-gray-600">
                                Đã bán <span class="ml-1">(1)</span>
                            </button>
                        </div>
                    </div>

                    <div class="mt-4">
                        <!-- PANEL: ĐÃ ĐĂNG -->
                        <div data-panel="da-dang" class="panel-grid space-y-5">
                            <!-- Grid sản phẩm ĐÃ ĐĂNG -->
                            <div id="productGridDang" class="grid grid-cols-2 md:grid-cols-3 gap-6 mt-6"
                                style="width: 931px;">
                                <!-- Item 1 -->
                                <div class="product relative w-64 mx-auto bg-white border-2 rounded-lg shadow p-2 cursor-pointer flex flex-col"
                                    data-hot="true" data-date="2025-09-18" data-price="10000">
                                    <div class="relative h-40 w-full">
                                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSEjyltjwRdW4jYfVehr5-pqgQDGDqeGlYQ2Q&s"
                                            class="rounded-md w-full h-full object-cover" />
                                        <span
                                            class="absolute top-3 left-2 bg-black/80 text-white text-xs font-semibold px-2 py-1 rounded-full">Hot</span>
                                        <button onclick="toggleFavorite(this)"
                                            class="absolute top-2 right-2 w-8 h-8 flex items-center justify-center bg-white/80 backdrop-blur-sm rounded-full hover:scale-110 transition">
                                            <i class="fa-regular fa-heart text-red-600"></i>
                                        </button>
                                        <div
                                            class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs px-2 py-1 flex justify-between items-center rounded-b-md">
                                            <span>1 ngày trước</span>
                                            <span>+3 <img src="image/image.png" alt="icon"
                                                    class="w-3 h-3 inline-block"></span>
                                        </div>
                                    </div>
                                    <div class="mt-2 text-sm flex flex-col flex-grow justify-between">
                                        <div>
                                            <p class="font-semibold text-base">Nồi cơm Delites</p>
                                            <p class="text-gray-500">1.8 lít, bảo hành 12 tháng</p>
                                            <p class="text-gray-500">Quận Thanh Khê, Đà Nẵng</p>
                                        </div>
                                        <p class="text-red-600 font-medium mt-1 text-lg">10.000đ</p>
                                    </div>
                                </div>

                                <!-- Item 1 -->
                                <div class="product relative w-64 mx-auto bg-white border-2 rounded-lg shadow p-2 cursor-pointer flex flex-col"
                                    data-hot="true" data-date="2025-09-18" data-price="10000">
                                    <div class="relative h-40 w-full">
                                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSEjyltjwRdW4jYfVehr5-pqgQDGDqeGlYQ2Q&s"
                                            class="rounded-md w-full h-full object-cover" />
                                        <span
                                            class="absolute top-3 left-2 bg-black/80 text-white text-xs font-semibold px-2 py-1 rounded-full">Hot</span>
                                        <button onclick="toggleFavorite(this)"
                                            class="absolute top-2 right-2 w-8 h-8 flex items-center justify-center bg-white/80 backdrop-blur-sm rounded-full hover:scale-110 transition">
                                            <i class="fa-regular fa-heart text-red-600"></i>
                                        </button>
                                        <div
                                            class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs px-2 py-1 flex justify-between items-center rounded-b-md">
                                            <span>1 ngày trước</span>
                                            <span>+3 <img src="image/image.png" alt="icon"
                                                    class="w-3 h-3 inline-block"></span>
                                        </div>
                                    </div>
                                    <div class="mt-2 text-sm flex flex-col flex-grow justify-between">
                                        <div>
                                            <p class="font-semibold text-base">Nồi cơm Delites</p>
                                            <p class="text-gray-500">1.8 lít, bảo hành 12 tháng</p>
                                            <p class="text-gray-500">Quận Thanh Khê, Đà Nẵng</p>
                                        </div>
                                        <p class="text-red-600 font-medium mt-1 text-lg">10.000đ</p>
                                    </div>
                                </div>


                                <!-- Item 2 -->
                                <div class="product relative w-64 mx-auto bg-white border-2 rounded-lg shadow p-2 cursor-pointer flex flex-col"
                                    data-hot="true" data-date="2025-09-18" data-price="10000">
                                    <div class="relative h-40 w-full">
                                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSEjyltjwRdW4jYfVehr5-pqgQDGDqeGlYQ2Q&s"
                                            class="rounded-md w-full h-full object-cover" />
                                        <span
                                            class="absolute top-3 left-2 bg-black/80 text-white text-xs font-semibold px-2 py-1 rounded-full">Hot</span>
                                        <button onclick="toggleFavorite(this)"
                                            class="absolute top-2 right-2 w-8 h-8 flex items-center justify-center bg-white/80 backdrop-blur-sm rounded-full hover:scale-110 transition">
                                            <i class="fa-regular fa-heart text-red-600"></i>
                                        </button>
                                        <div
                                            class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs px-2 py-1 flex justify-between items-center rounded-b-md">
                                            <span>1 ngày trước</span>
                                            <span>+3 <img src="image/image.png" alt="icon"
                                                    class="w-3 h-3 inline-block"></span>
                                        </div>
                                    </div>
                                    <div class="mt-2 text-sm flex flex-col flex-grow justify-between">
                                        <div>
                                            <p class="font-semibold text-base">Nồi cơm Delites</p>
                                            <p class="text-gray-500">1.8 lít, bảo hành 12 tháng</p>
                                            <p class="text-gray-500">Quận Thanh Khê, Đà Nẵng</p>
                                        </div>
                                        <p class="text-red-600 font-medium mt-1 text-lg">10.000đ</p>
                                    </div>
                                </div>

                                <!-- Item 2 -->
                                <div class="product relative w-64 mx-auto bg-white border-2 rounded-lg shadow p-2 cursor-pointer flex flex-col"
                                    data-hot="true" data-date="2025-09-18" data-price="10000">
                                    <div class="relative h-40 w-full">
                                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSEjyltjwRdW4jYfVehr5-pqgQDGDqeGlYQ2Q&s"
                                            class="rounded-md w-full h-full object-cover" />
                                        <span
                                            class="absolute top-3 left-2 bg-black/80 text-white text-xs font-semibold px-2 py-1 rounded-full">Hot</span>
                                        <button onclick="toggleFavorite(this)"
                                            class="absolute top-2 right-2 w-8 h-8 flex items-center justify-center bg-white/80 backdrop-blur-sm rounded-full hover:scale-110 transition">
                                            <i class="fa-regular fa-heart text-red-600"></i>
                                        </button>
                                        <div
                                            class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs px-2 py-1 flex justify-between items-center rounded-b-md">
                                            <span>1 ngày trước</span>
                                            <span>+3 <img src="image/image.png" alt="icon"
                                                    class="w-3 h-3 inline-block"></span>
                                        </div>
                                    </div>
                                    <div class="mt-2 text-sm flex flex-col flex-grow justify-between">
                                        <div>
                                            <p class="font-semibold text-base">Nồi cơm Delites</p>
                                            <p class="text-gray-500">1.8 lít, bảo hành 12 tháng</p>
                                            <p class="text-gray-500">Quận Thanh Khê, Đà Nẵng</p>
                                        </div>
                                        <p class="text-red-600 font-medium mt-1 text-lg">10.000đ</p>
                                    </div>
                                </div>

                                <!-- Item 2 -->
                                <div class="product relative w-64 mx-auto bg-white border-2 rounded-lg shadow p-2 cursor-pointer flex flex-col"
                                    data-hot="true" data-date="2025-09-18" data-price="10000">
                                    <div class="relative h-40 w-full">
                                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSEjyltjwRdW4jYfVehr5-pqgQDGDqeGlYQ2Q&s"
                                            class="rounded-md w-full h-full object-cover" />
                                        <span
                                            class="absolute top-3 left-2 bg-black/80 text-white text-xs font-semibold px-2 py-1 rounded-full">Hot</span>
                                        <button onclick="toggleFavorite(this)"
                                            class="absolute top-2 right-2 w-8 h-8 flex items-center justify-center bg-white/80 backdrop-blur-sm rounded-full hover:scale-110 transition">
                                            <i class="fa-regular fa-heart text-red-600"></i>
                                        </button>
                                        <div
                                            class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs px-2 py-1 flex justify-between items-center rounded-b-md">
                                            <span>1 ngày trước</span>
                                            <span>+3 <img src="image/image.png" alt="icon"
                                                    class="w-3 h-3 inline-block"></span>
                                        </div>
                                    </div>
                                    <div class="mt-2 text-sm flex flex-col flex-grow justify-between">
                                        <div>
                                            <p class="font-semibold text-base">Nồi cơm Delites</p>
                                            <p class="text-gray-500">1.8 lít, bảo hành 12 tháng</p>
                                            <p class="text-gray-500">Quận Thanh Khê, Đà Nẵng</p>
                                        </div>
                                        <p class="text-red-600 font-medium mt-1 text-lg">10.000đ</p>
                                    </div>
                                </div>

                                <!-- Item 2 -->
                                <div class="product relative w-64 mx-auto bg-white border-2 rounded-lg shadow p-2 cursor-pointer flex flex-col"
                                    data-hot="true" data-date="2025-09-18" data-price="10000">
                                    <div class="relative h-40 w-full">
                                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSEjyltjwRdW4jYfVehr5-pqgQDGDqeGlYQ2Q&s"
                                            class="rounded-md w-full h-full object-cover" />
                                        <span
                                            class="absolute top-3 left-2 bg-black/80 text-white text-xs font-semibold px-2 py-1 rounded-full">Hot</span>
                                        <button onclick="toggleFavorite(this)"
                                            class="absolute top-2 right-2 w-8 h-8 flex items-center justify-center bg-white/80 backdrop-blur-sm rounded-full hover:scale-110 transition">
                                            <i class="fa-regular fa-heart text-red-600"></i>
                                        </button>
                                        <div
                                            class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs px-2 py-1 flex justify-between items-center rounded-b-md">
                                            <span>1 ngày trước</span>
                                            <span>+3 <img src="image/image.png" alt="icon"
                                                    class="w-3 h-3 inline-block"></span>
                                        </div>
                                    </div>
                                    <div class="mt-2 text-sm flex flex-col flex-grow justify-between">
                                        <div>
                                            <p class="font-semibold text-base">Nồi cơm Delites</p>
                                            <p class="text-gray-500">1.8 lít, bảo hành 12 tháng</p>
                                            <p class="text-gray-500">Quận Thanh Khê, Đà Nẵng</p>
                                        </div>
                                        <p class="text-red-600 font-medium mt-1 text-lg">10.000đ</p>
                                    </div>
                                </div>

                                <!-- Item 3 -->
                                <div class="product relative w-64 mx-auto bg-white border-2 rounded-lg shadow p-2 cursor-pointer flex flex-col"
                                    data-hot="true" data-date="2025-09-18" data-price="10000">
                                    <div class="relative h-40 w-full">
                                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSEjyltjwRdW4jYfVehr5-pqgQDGDqeGlYQ2Q&s"
                                            class="rounded-md w-full h-full object-cover" />
                                        <span
                                            class="absolute top-3 left-2 bg-black/80 text-white text-xs font-semibold px-2 py-1 rounded-full">Hot</span>
                                        <button onclick="toggleFavorite(this)"
                                            class="absolute top-2 right-2 w-8 h-8 flex items-center justify-center bg-white/80 backdrop-blur-sm rounded-full hover:scale-110 transition">
                                            <i class="fa-regular fa-heart text-red-600"></i>
                                        </button>
                                        <div
                                            class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs px-2 py-1 flex justify-between items-center rounded-b-md">
                                            <span>1 ngày trước</span>
                                            <span>+3 <img src="image/image.png" alt="icon"
                                                    class="w-3 h-3 inline-block"></span>
                                        </div>
                                    </div>
                                    <div class="mt-2 text-sm flex flex-col flex-grow justify-between">
                                        <div>
                                            <p class="font-semibold text-base">Nồi cơm Delites</p>
                                            <p class="text-gray-500">1.8 lít, bảo hành 12 tháng</p>
                                            <p class="text-gray-500">Quận Thanh Khê, Đà Nẵng</p>
                                        </div>
                                        <p class="text-red-600 font-medium mt-1 text-lg">10.000đ</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Nút Xem thêm -->
                            <div class="mt-4 text-center">
                                <button id="loadMoreDang"
                                    class="px-8 py-2 bg-white text-black font-medium rounded-md hover:bg-gray-200 border border-gray-300">
                                    Xem thêm
                                </button>
                            </div>
                        </div>

                        <!-- PANEL: ĐÃ BÁN -->
                        <div data-panel="da-ban" class="panel-grid space-y-5 hidden">
                            <!-- Grid sản phẩm ĐÃ BÁN -->
                            <div id="productGridBan" class="grid grid-cols-2 md:grid-cols-3 gap-6 mt-6"
                                style="width: 931px;">
                                <!-- Item 1 -->
                                <div class="product relative w-64 mx-auto bg-white border-2 rounded-lg shadow p-2 cursor-pointer flex flex-col"
                                    data-hot="true" data-date="2025-09-18" data-price="10000">
                                    <div class="relative h-40 w-full">
                                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSEjyltjwRdW4jYfVehr5-pqgQDGDqeGlYQ2Q&s"
                                            class="rounded-md w-full h-full object-cover" />
                                        <span
                                            class="absolute top-3 left-2 bg-black/80 text-white text-xs font-semibold px-2 py-1 rounded-full">Đã
                                            bán</span>
                                        <button onclick="toggleFavorite(this)"
                                            class="absolute top-2 right-2 w-8 h-8 flex items-center justify-center bg-white/80 backdrop-blur-sm rounded-full hover:scale-110 transition">
                                            <i class="fa-regular fa-heart text-red-600"></i>
                                        </button>
                                        <div
                                            class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs px-2 py-1 flex justify-between items-center rounded-b-md">
                                            <span>1 ngày trước</span>
                                            <span>+3 <img src="image/image.png" alt="icon"
                                                    class="w-3 h-3 inline-block"></span>
                                        </div>
                                    </div>
                                    <div class="mt-2 text-sm flex flex-col flex-grow justify-between">
                                        <div>
                                            <p class="font-semibold text-base">Nồi cơm Delites</p>
                                            <p class="text-gray-500">1.8 lít, bảo hành 12 tháng</p>
                                            <p class="text-gray-500">Quận Thanh Khê, Đà Nẵng</p>
                                        </div>
                                        <p class="text-red-600 font-medium mt-1 text-lg">10.000đ</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Nút Xem thêm -->
                            <div class="mt-4 text-center">
                                <button id="loadMoreBan"
                                    class="px-8 py-2 bg-white text-black font-medium rounded-md hover:bg-gray-200 border border-gray-300">
                                    Xem thêm
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- JS chuyển tab -->
                <script>
                    (function () {
                        const tabBtns = document.querySelectorAll('.tab-btn');
                        const panels = document.querySelectorAll('[data-panel]');

                        tabBtns.forEach(btn => {
                            btn.addEventListener('click', () => {
                                // style tabs
                                tabBtns.forEach(b => {
                                    b.classList.remove('text-red-600', 'border-red-500');
                                    b.classList.add('text-gray-600', 'border-transparent');
                                });
                                btn.classList.add('text-red-600', 'border-red-500');
                                btn.classList.remove('text-gray-600', 'border-transparent');

                                // show panel
                                const key = btn.getAttribute('data-tab');
                                panels.forEach(p => p.classList.toggle('hidden', p.getAttribute('data-panel') !== key));
                            });
                        });
                    })();
                </script>

                <script>
                    // JS của trái tim
                    function toggleFavorite(btn) {
                        const icon = btn.querySelector("i");
                        if (icon.classList.contains("fa-regular")) {
                            icon.classList.remove("fa-regular");
                            icon.classList.add("fa-solid");
                        } else {
                            icon.classList.remove("fa-solid");
                            icon.classList.add("fa-regular");
                        }
                    }
                </script>

                <script>
                    // Hàm thiết lập chức năng Xem thêm
                    function setupLoadMore(gridId, btnId, step = 3) {
                        const grid = document.getElementById(gridId);
                        const btn = document.getElementById(btnId);
                        if (!grid || !btn) return;

                        let visibleCount = step * 2; // số sản phẩm hiển thị ban đầu
                        const products = Array.from(grid.getElementsByClassName("product"));

                        function showProducts() {
                            products.forEach((p, i) => {
                                p.style.display = i < visibleCount ? "block" : "none";
                            });
                            btn.style.display = visibleCount >= products.length ? "none" : "inline-block";
                        }

                        btn.addEventListener("click", () => {
                            visibleCount += step;
                            showProducts();
                        });

                        // Khởi tạo
                        showProducts();
                    }

                    // Gọi cho từng panel
                    setupLoadMore("productGridDang", "loadMoreDang");
                    setupLoadMore("productGridBan", "loadMoreBan");
                </script>


            </div>
        </section>
    </main>

    <!-- Overlay cho modal -->
    <div id="modalOverlay" class="hidden fixed inset-0 bg-black/50 z-[9998]"></div>
    <!-- Modal xác nhận đăng xuất -->
    <div th:replace="~{fragments/modallogout :: modallogout}"></div>

    <!-- FOOTER -->
    <div th:replace="~{fragments/footer :: footer}"></div>

    <!-- JS của phần Header không được xóa -->
    <script>
        const overlay = document.getElementById('overlay');
        const dropdowns = {
            menuBtn: 'menuDropdown',
            favBtn: 'favDropdown',
            notiBtn: 'notiDropdown',
            avatarBtn: 'dropdownMenu'
        };

        Object.entries(dropdowns).forEach(([btnId, menuId]) => {
            const btn = document.getElementById(btnId);
            const menu = document.getElementById(menuId);

            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = !menu.classList.contains('hidden');

                Object.values(dropdowns).forEach(id =>
                    document.getElementById(id).classList.add('hidden')
                );

                if (isOpen) {
                    menu.classList.add('hidden');
                    overlay.classList.add('hidden');
                } else {
                    menu.classList.remove('hidden');
                    overlay.classList.remove('hidden');
                }
            });
        });

        overlay.addEventListener('click', () => {
            overlay.classList.add('hidden');
            Object.values(dropdowns).forEach(id =>
                document.getElementById(id).classList.add('hidden')
            );
        });

        document.addEventListener('click', (e) => {
            if (!Object.keys(dropdowns).some(btnId =>
                document.getElementById(btnId).contains(e.target)
            )) {
                overlay.classList.add('hidden');
                Object.values(dropdowns).forEach(id =>
                    document.getElementById(id).classList.add('hidden')
                );
            }
        });

        // JS xử lý đăng xuất
        (() => {
            const overlay = document.getElementById('modalOverlay');
            const modal = document.getElementById('logoutConfirm');
            const btnOK = document.getElementById('logoutSubmit');
            const btnNO = document.getElementById('logoutCancel');

            let targetForm = null; // form sẽ được submit khi bấm "Có"

            function openModal(form) {
                targetForm = form;
                overlay.classList.remove('hidden');
                modal.classList.remove('hidden');
            }
            function closeModal() {
                overlay.classList.add('hidden');
                modal.classList.add('hidden');
                targetForm = null;
            }

            // Bắt các nút logout
            document.querySelectorAll('.js-logout-trigger').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const form = btn.closest('form');
                    if (!form) return;
                    openModal(form);
                });
            });

            // Nút "Không"
            btnNO.addEventListener('click', (e) => {
                e.preventDefault();
                closeModal();
            });

            // Nút "Có"
            btnOK.addEventListener('click', (e) => {
                e.preventDefault();
                if (targetForm) {
                    // tránh submit đôi
                    btnOK.disabled = true;
                    targetForm.submit();
                } else {
                    closeModal();
                }
            });

            // Click ra ngoài hộp => đóng
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            overlay.addEventListener('click', closeModal);
        })();

        // Hàm lấy CSRF token
        function getCSRFToken() {
            const csrfToken = document.querySelector('meta[name="_csrf"]');
            if (csrfToken) {
                return '_csrf=' + encodeURIComponent(csrfToken.getAttribute('content'));
            }
            return '';
        }
    </script>
</body>

</html>