<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Student Market</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        .menu-parent:hover .menu-child {
            display: block;
        }
    </style>
</head>

<body class="bg-gray-100">
    <!-- Overlay nền mờ -->
    <div id="overlay" class="hidden fixed inset-0 bg-black/50 z-40"></div>

    <!-- Header -->
    <div th:replace="~{fragments/headerUSER :: headerUSER}"></div>

    <!-- MAIN -->
    <main class="pt-14 pb-10">
    <div class="max-w-7xl mx-auto px-4 pt-8">

      <!-- PROFILE -->
      <section class="bg-white rounded-2xl shadow p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3">
          <!-- Cột 1 -->
          <div class="flex items-center gap-4 px-2 py-4 md:py-0 md:pr-6 md:border-r">
            <div class="relative shrink-0 w-20 h-20">
              <img th:src="${session.picture} ?: @{/image/header/profile-user.png}" alt="Avatar"
                class="w-20 h-20 rounded-full object-cover border" />
              <button type="button"
                class="absolute bottom-0 right-0 bg-gray-200 rounded-full p-1 shadow hover:bg-gray-300">
                <img th:src="@{/image/thongtintaikhoan/photo-camera.png}" alt="Đổi ảnh đại diện" class="w-4 h-4" />
              </button>
            </div>

            <div class="flex flex-col justify-center">
              <h2 class="text-base font-semibold text-gray-900 truncate" th:text="${session.full_name} ?: 'Người dùng'">
              </h2>
              <div class="mt-1 flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-600">
                <span>Người theo dõi: <b class="font-semibold text-gray-900">18</b></span>
                <span class="hidden md:inline text-gray-300">|</span>
                <span>Đang theo dõi: <b class="font-semibold text-gray-900">3</b></span>
              </div>
            </div>
          </div>

          <!-- Cột 2 -->
          <div class="px-2 py-4 md:py-0 md:px-6 md:border-r flex items-center justify-center text-center">
            <div>
              <p class="text-base font-semibold text-gray-900">Đánh giá</p>
              <div class="mt-1 flex items-center justify-center gap-1" aria-label="4.7 trên 5">
                <i class="fa-solid fa-star text-yellow-400"></i>
                <i class="fa-solid fa-star text-yellow-400"></i>
                <i class="fa-solid fa-star text-yellow-400"></i>
                <i class="fa-solid fa-star text-yellow-400"></i>
                <i class="fa-solid fa-star text-gray-300"></i>
              </div>
              <p class="mt-1 text-sm text-gray-900">
                <span class="font-semibold">4.7</span>
                <span class="text-gray-400">(14 đánh giá)</span>
              </p>
            </div>
          </div>

          <!-- Cột 3 -->
          <div class="px-2 py-4 md:py-0 md:pl-6 flex items-center justify-center">
            <div class="flex items-center gap-3">
              <div class="w-16 h-16 rounded-full bg-yellow-100 flex items-center justify-center">
                <img th:src="@{/image/thongtintaikhoan/star.png}" alt="Star" class="w-10 h-10" />
              </div>
              <div class="flex flex-col justify-center">
                <p class="text-base font-semibold text-gray-900">Điểm tích luỹ</p>
                <p class="mt-0.5 text-sm text-gray-600">Khả dụng: <b class="font-semibold text-gray-900">200 điểm</b>
                </p>
                <p class="text-sm text-gray-600">Tổng tích luỹ: <b class="font-semibold text-gray-900">510 điểm</b></p>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- Layout 2 cột -->
      <div class="flex flex-col md:flex-row gap-6">
        <div class="flex flex-col md:flex-row gap-6">

          <!-- Sidebar -->
          <aside class="md:col-span-3">
            <nav class="bg-white rounded-2xl shadow divide-y top-24 w-[245px]">
              <a class="flex items-center gap-3 px-6 py-3 hover:bg-gray-50 rounded-tl-2xl rounded-tr-2xl"
                th:href="@{/tongquan}">
                <img th:src="@{/image/thongtintaikhoan/home.png}" alt="Tổng Quan" class="w-6 h-6 object-cover" />
                <span class="text-gray-800 font-semibold">Tổng Quan</span>
              </a>
              <a class="flex items-center gap-3 px-6 py-3 hover:bg-gray-50" th:href="@{/thongtintaikhoan}">
                <img th:src="@{/image/thongtintaikhoan/setting.png}" alt="Thông tin tài khoản"
                  class="w-6 h-6 object-cover" />
                <span class="text-gray-800 font-semibold">Thông tin tài khoản</span>
              </a>
              <a class="flex items-center gap-3 px-6 py-3 hover:bg-gray-50" th:href="@{/quanlybaidang}">
                <img th:src="@{/image/thongtintaikhoan/edit.png}" alt="Quản lí bài đăng" class="w-6 h-6 object-cover" />
                <span class="text-gray-800 font-semibold">Quản lý bài đăng</span>
              </a>
              <a class="flex items-center gap-3 px-6 py-3 bg-red-50" th:href="@{/lichsugiaodich}">
                <img th:src="@{/image/thongtintaikhoan/file-red.png}" alt="Lịch sử giao dịch"
                  class="w-6 h-6 object-cover" />
                <span class="text-red-600 font-semibold">Lịch sử giao dịch</span>
              </a>
              <a class="flex items-center gap-3 px-6 py-3 hover:bg-gray-50" th:href="@{/tichluydiem}">
                <img th:src="@{/image/thongtintaikhoan/tichluy.png}" alt="Tích lũy điểm" class="w-6 h-6 object-cover" />
                <span class="text-gray-800 font-semibold">Tích lũy điểm</span>
              </a>
              <a class="flex items-center gap-3 px-6 py-3 hover:bg-gray-50" th:href="@{/danhgia}">
                <img th:src="@{/image/thongtintaikhoan/danhgia.png}" alt="Đánh giá" class="w-6 h-6 object-cover" />
                <span class="text-gray-800 font-semibold">Đánh giá</span>
              </a>
              <a class="flex items-center gap-3 px-6 py-3 hover:bg-gray-50" th:href="@{/gopy}">
                <img th:src="@{/image/thongtintaikhoan/gopy.png}" alt="Góp ý & hỗ trợ" class="w-6 h-6 object-cover" />
                <span class="text-gray-800 font-semibold">Góp ý & hỗ trợ</span>
              </a>
              <a class="flex items-center gap-3 px-6 py-3 hover:bg-gray-50" th:href="@{/dieukhoansudung}">
                <img th:src="@{/image/thongtintaikhoan/dieukhoan.png}" alt="Điều khoản sử dụng"
                  class="w-6 h-6 object-cover" />
                <span class="text-gray-800 font-semibold">Điều khoản sử dụng</span>
              </a>
              <form th:action="@{/logout}" method="post"
                class="flex items-center gap-3 px-6 py-3 hover:bg-gray-50 rounded-bl-2xl rounded-br-2xl">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="flex items-center gap-3 w-full text-left">
                  <img th:src="@{/image/thongtintaikhoan/dangxuat.png}" alt="Đăng xuất" class="w-6 h-6 object-cover" />
                  <span class="text-gray-800 font-semibold">Đăng xuất</span>
                </button>
              </form>
            </nav>
          </aside>

          <!-- LỊCH SỬ GIAO DỊCH -->
          <section class="flex-1">
            <div class="bg-white rounded-2xl shadow px-6 w-[980px]" style="padding-bottom: 24px;">
              <!-- Tabs + Search -->
              <div class="w-full">
                <div id="lsTabs" class="grid grid-cols-4 text-sm font-semibold text-center border-b border-gray-200">
                  <button data-tab="dang-yeu-cau" class="tab-btn py-3 border-b-2 border-red-500 text-red-600">
                    Đang yêu cầu <span class="ml-1">(<span id="count-REQUESTING">0</span>)</span>
                  </button>
                  <button data-tab="dang-giao-dich" class="tab-btn py-3 border-b-2 border-transparent text-gray-600">
                    Đang giao dịch <span class="ml-1">(<span id="count-IN_PROGRESS">0</span>)</span>
                  </button>
                  <button data-tab="hoan-thanh" class="tab-btn py-3 border-b-2 border-transparent text-gray-600">
                    Hoàn thành <span class="ml-1">(<span id="count-COMPLETED">0</span>)</span>
                  </button>
                  <button data-tab="da-huy" class="tab-btn py-3 border-b-2 border-transparent text-gray-600">
                    Đã hủy <span class="ml-1">(<span id="count-CANCELLED">0</span>)</span>
                  </button>
                </div>

                <div class="flex justify-end mt-3">
                  <div class="relative w-80 max-w-full">
                    <input id="lsSearch" type="text" placeholder="Tìm đơn hàng của bạn..."
                      class="w-full pl-10 pr-3 py-2 text-sm rounded-full border border-gray-200 focus:outline-none focus:ring-2 focus:ring-red-400">
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1110.5 3a7.5 7.5 0 016.15 13.65z" />
                    </svg>
                  </div>
                </div>
              </div>

              <!-- Panels -->
              <div class="mt-4">
                <div data-panel="dang-yeu-cau" class="panel-grid space-y-5"></div>
                <div class="mt-4 text-center" data-more="dang-yeu-cau">
                  <button
                    class="load-more px-8 py-2 bg-white text-black font-medium rounded-md hover:bg-gray-200 border border-gray-300">Xem
                    thêm</button>
                </div>

                <div data-panel="dang-giao-dich" class="panel-grid hidden space-y-5"></div>
                <div class="mt-4 text-center hidden" data-more="dang-giao-dich">
                  <button
                    class="load-more px-8 py-2 bg-white text-black font-medium rounded-md hover:bg-gray-200 border border-gray-300">Xem
                    thêm</button>
                </div>

                <div data-panel="hoan-thanh" class="panel-grid hidden space-y-5"></div>
                <div class="mt-4 text-center hidden" data-more="hoan-thanh">
                  <button
                    class="load-more px-8 py-2 bg-white text-black font-medium rounded-md hover:bg-gray-200 border border-gray-300">Xem
                    thêm</button>
                </div>

                <div data-panel="da-huy" class="panel-grid hidden space-y-5"></div>
                <div class="mt-4 text-center hidden" data-more="da-huy">
                  <button
                    class="load-more px-8 py-2 bg-white text-black font-medium rounded-md hover:bg-gray-200 border border-gray-300">Xem
                    thêm</button>
                </div>
              </div>
            </div>
          </section>

          <!-- MODAL ĐÁNH GIÁ -->
          <div id="rateModal" class="hidden fixed inset-0 z-[9999] flex items-center justify-center">
            <div class="absolute inset-0 bg-black/50"></div>
            <div class="relative w-[520px] max-w-[92vw] bg-white rounded-xl shadow-lg p-5 z-10">
              <div class="flex items-center justify-between">
                <h3 id="rateTitle" class="text-base font-bold text-gray-900">Đánh giá</h3>
                <button id="rateClose"
                  class="absolute top-3 right-3 w-9 h-9 flex items-center justify-center rounded-full hover:bg-gray-100">
                  <i class="fa-solid fa-xmark text-lg text-gray-600"></i>
                </button>
              </div>
              <div class="mt-3 flex items-center gap-1" id="starWrap" aria-label="Chọn số sao"></div>
              <textarea id="rateContent" rows="4"
                class="mt-3 w-full text-sm rounded-md border border-gray-300 p-2 focus:outline-none focus:ring-2 focus:ring-red-400"
                placeholder="Chia sẻ trải nghiệm của bạn..."></textarea>
              <div class="mt-4 flex justify-end gap-2">
                <button id="rateCancel"
                  class="px-3 py-1.5 text-sm rounded-md bg-gray-100 hover:bg-gray-200">Hủy</button>
                <button id="rateSave"
                  class="px-3 py-1.5 text-sm rounded-md bg-red-600 text-white hover:bg-red-700">Lưu</button>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </main>

    <!-- Overlay cho modal -->
    <div id="modalOverlay" class="hidden fixed inset-0 bg-black/50 z-[9998]"></div>
    <!-- Modal xác nhận đăng xuất -->
    <div th:replace="~{fragments/modallogout :: modallogout}"></div>

    <!-- FOOTER -->
    <div th:replace="~{fragments/footer :: footer}"></div>


    <!-- JS nho nhỏ cho tab & search -->
    <script>
        // Tab switching
        const tabBtns = document.querySelectorAll('.tab-btn');
        const panels = document.querySelectorAll('[data-panel]');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // reset tất cả tab về trạng thái inactive
                tabBtns.forEach(b => {
                    b.classList.remove('text-red-600', 'border-red-500');
                    b.classList.add('text-gray-600', 'border-transparent');
                });

                // kích hoạt tab vừa bấm
                btn.classList.remove('text-gray-600', 'border-transparent');
                btn.classList.add('text-red-600', 'border-red-500');

                // hiện panel tương ứng
                const name = btn.getAttribute('data-tab');
                panels.forEach(p => p.classList.toggle('hidden', p.getAttribute('data-panel') !== name));
            });
        });

        // Simple client-side search over titles
        const search = document.getElementById('lsSearch');
        if (search) {
            search.addEventListener('input', () => {
                const q = search.value.toLowerCase().trim();
                document.querySelectorAll('.request-card').forEach(card => {
                    const title = card.querySelector('h3')?.textContent.toLowerCase() || '';
                    card.classList.toggle('hidden', !title.includes(q));
                });
            });
        }
    </script>

    <!-- JS xem thêm sản phẩm -->
    <script>
        // cấu hình
        const INITIAL_COUNT = 2;
        const STEP = 2;

        // khởi tạo paginate cho từng panel có class panel-grid
        document.querySelectorAll('.panel-grid').forEach(panel => {
            const cards = Array.from(panel.getElementsByClassName('request-card'));
            const btn = panel.querySelector('.load-more');
            let visible = Math.min(INITIAL_COUNT, cards.length);

            function render() {
                cards.forEach((c, i) => c.style.display = i < visible ? '' : 'none');
                if (btn) btn.style.display = visible >= cards.length ? 'none' : 'inline-flex';
            }

            if (btn) {
                btn.addEventListener('click', () => {
                    visible += STEP;
                    render();
                });
            }

            render();
        });

        // JS xử lý đăng xuất
        (() => {
            const overlay = document.getElementById('modalOverlay');
            const modal = document.getElementById('logoutConfirm');
            const btnOK = document.getElementById('logoutSubmit');
            const btnNO = document.getElementById('logoutCancel');

            let targetForm = null; // form sẽ được submit khi bấm "Có"

            function openModal(form) {
                targetForm = form;
                overlay.classList.remove('hidden');
                modal.classList.remove('hidden');
            }
            function closeModal() {
                overlay.classList.add('hidden');
                modal.classList.add('hidden');
                targetForm = null;
            }

            // Bắt các nút logout
            document.querySelectorAll('.js-logout-trigger').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const form = btn.closest('form');
                    if (!form) return;
                    openModal(form);
                });
            });

            // Nút "Không"
            btnNO.addEventListener('click', (e) => {
                e.preventDefault();
                closeModal();
            });

            // Nút "Có"
            btnOK.addEventListener('click', (e) => {
                e.preventDefault();
                if (targetForm) {
                    // tránh submit đôi
                    btnOK.disabled = true;
                    targetForm.submit();
                } else {
                    closeModal();
                }
            });

            // Click ra ngoài hộp => đóng
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            overlay.addEventListener('click', closeModal);
        })();

        // Hàm lấy CSRF token
        function getCSRFToken() {
            const csrfToken = document.querySelector('meta[name="_csrf"]');
            if (csrfToken) {
                return '_csrf=' + encodeURIComponent(csrfToken.getAttribute('content'));
            }
            return '';
        }
    </script>

    <!-- JS của phần Header không được xóa -->
    <script>
        const overlay = document.getElementById('overlay');
        const dropdowns = {
            menuBtn: 'menuDropdown',
            favBtn: 'favDropdown',
            notiBtn: 'notiDropdown',
            avatarBtn: 'dropdownMenu'
        };

        Object.entries(dropdowns).forEach(([btnId, menuId]) => {
            const btn = document.getElementById(btnId);
            const menu = document.getElementById(menuId);

            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = !menu.classList.contains('hidden');

                Object.values(dropdowns).forEach(id =>
                    document.getElementById(id).classList.add('hidden')
                );

                if (isOpen) {
                    menu.classList.add('hidden');
                    overlay.classList.add('hidden');
                } else {
                    menu.classList.remove('hidden');
                    overlay.classList.remove('hidden');
                }
            });
        });

        overlay.addEventListener('click', () => {
            overlay.classList.add('hidden');
            Object.values(dropdowns).forEach(id =>
                document.getElementById(id).classList.add('hidden')
            );
        });

        document.addEventListener('click', (e) => {
            if (!Object.keys(dropdowns).some(btnId =>
                document.getElementById(btnId).contains(e.target)
            )) {
                overlay.classList.add('hidden');
                Object.values(dropdowns).forEach(id =>
                    document.getElementById(id).classList.add('hidden')
                );
            }
        });
    </script>
    

    <script>
    
    (function () {
      // ===== API config =====
      const FILTER_ROLE = 'BUYER';

const API = {
  list: (status, page=0, size=4) =>
    `/api/transactions/mine?status=${status}&role=${FILTER_ROLE}&page=${page}&size=${size}`,
  counts: () => `/api/transactions/counts/mine?role=${FILTER_ROLE}`,
  cancel: id => `/api/transactions/${id}/cancel`,
  rate: id => `/api/transactions/${id}/rate`,
  updateNote: id => `/api/transactions/${id}/note`
};




      // ===== CSRF helper =====
      function csrfFetch(url, options = {}) {
        const token = document.querySelector('meta[name="_csrf"]')?.content;
        const header = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';
        const o = options || {};
        o.headers = o.headers || {};
        if (token) o.headers[header] = token;
        if (o.method && o.method !== 'GET' && !o.headers['Content-Type']) {
          o.headers['Content-Type'] = 'application/json';
        }
        return fetch(url, o);
      }

      // ===== Auth info =====
      const rawMe = document.querySelector('meta[name="meId"]')?.content;
const meId = Number.parseInt(rawMe, 10);
const hasMeId = Number.isFinite(meId) && meId > 0;
// debug (có thể bỏ khi xong):
console.debug('[TX] meId =', meId, 'raw =', rawMe);

      // ===== Global state =====
      const state = {};
      const ratedTxIds = new Set(); // các giao dịch tôi đã đánh giá
      const tabMap = {
        'dang-yeu-cau': 'REQUESTING',
        'dang-giao-dich': 'IN_PROGRESS',
        'hoan-thanh': 'COMPLETED',
        'da-huy': 'CANCELLED'
      };
      Object.keys(tabMap).forEach(k => state[k] = { page: 0, size: 4, totalPages: 1, items: [] });
      let activeTab = 'dang-yeu-cau';

      // ===== Elements =====
      const searchInput = document.getElementById('lsSearch');

      // ===== Render 1 card =====
    function renderCard(item, tabKey) {
  const canCancel = (tabKey==='dang-yeu-cau' || tabKey==='dang-giao-dich');
  const statusColor = {
    'REQUESTING': 'text-blue-600',
    'IN_PROGRESS': 'text-orange-500',
    'COMPLETED': 'text-green-500',
    'CANCELLED': 'text-red-500'
  }[item.status] || 'text-gray-600';

  const isSeller = (meId && item.sellerId && meId === Number(item.sellerId));
  const rateLabel = isSeller ? 'Đánh giá người mua' : 'Đánh giá người bán';
  const canRate = (tabKey === 'hoan-thanh') && !ratedTxIds.has(Number(item.id));

  // ⬇️ phần ghi chú: nếu là tab đang-yeu-cau thì cho phép sửa
  const noteBlock = (tabKey === 'dang-yeu-cau')
    ? `
      <div class="relative w-[540px] max-w-[60vw]">
        <div class="rounded-xl bg-gray-100 p-3 md:p-5 shadow-inner ml-[10px]">
          <textarea class="note-input w-full text-[13px] md:text-sm text-gray-800 leading-relaxed bg-transparent outline-none"
            rows="3" placeholder="Nhập ghi chú cho người bán...">${item.note || ''}</textarea>
          <div class="mt-2 flex gap-2">
            <button class="btn-save-note inline-flex items-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-md border border-red-200 text-red-600 hover:bg-red-600 hover:text-white">
              <i class="fa-solid fa-floppy-disk"></i> Lưu
            </button>
          </div>
        </div>
      </div>`
    : (item.note
      ? `
      <div class="relative w-[540px] max-w-[60vw]">
        <div class="rounded-xl bg-gray-100 p-3 md:p-5 shadow-inner ml-[10px]">
          <p class="text-[13px] md:text-sm text-gray-800 leading-relaxed">“${item.note}”</p>
        </div>
      </div>` : ``);

  return `
  <div class="request-card group bg-white rounded-xl shadow-sm border border-gray-200 p-3 md:p-4 flex items-start gap-4 md:gap-5"
       data-id="${item.id}" data-status="${item.status}" data-name="${item.ownerName || ''}">
    <div class="w-28 h-28 md:w-32 md:h-32 shrink-0 rounded-lg overflow-hidden ring-1 ring-gray-100 ">
      <img src="${item.thumbUrl || 'https://via.placeholder.com/160'}" alt="${item.title}" class="w-full h-full object-cover">
    </div>
    <div class="flex-1 min-w-0">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <h3 class="text-base font-bold text-gray-900 truncate">${item.title}</h3>
          <p class="text-sm font-bold text-green-600 mt-0.5">${item.priceLabel || 'Miễn phí'}</p>
          <div class="mt-0.5 text-xs md:text-sm text-gray-600 space-y-0.5">
            <p>Người đăng: <span class="font-medium text-gray-900">${item.ownerName || ''}</span></p>
            <p>Ngày gửi yêu cầu: <span class="font-medium text-gray-900">${new Date(item.createdAt).toLocaleDateString('vi-VN')}</span></p>
          </div>
        </div>
        ${noteBlock}
      </div>
      <div class="mt-1 flex items-center justify-between">
        <p class="text-sm">Trạng thái:
          <span class="font-semibold ${statusColor}">
            ${item.status === 'REQUESTING' ? 'Đang chờ duyệt' :
              item.status === 'IN_PROGRESS' ? 'Đang giao dịch' :
              item.status === 'COMPLETED' ? 'Đã hoàn thành' : 'Đã hủy'}
          </span>
        </p>
        <div class="flex gap-2">
          ${tabKey==='dang-giao-dich' ? `
          <button class="btn-view-seller inline-flex items-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-md border border-gray-300 hover:bg-gray-100">
            <i class="fa-solid fa-user"></i> Xem thông tin người bán
          </button>` : ``}

          ${canRate ? `
          <button class="btn-rate inline-flex items-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-full border border-red-200 text-red-600 hover:bg-red-600 hover:text-white">
            <i class="fa-solid fa-star"></i> ${rateLabel}
          </button>` : ``}

          ${canCancel ? `
          <button class="btn-cancel inline-flex items-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-full border border-red-200 text-red-600 hover:bg-red-600 hover:text-white">
            <i class="fa-solid fa-circle-xmark"></i> ${tabKey==='dang-yeu-cau' ? 'Hủy yêu cầu' : 'Hủy giao dịch'}
          </button>` : ``}
        </div>
      </div>
    </div>
  </div>`;
}


      // ===== Render panel =====
      function paintPanel(tabKey) {
        const panel = document.querySelector(`[data-panel="${tabKey}"]`);
        const moreWrap = document.querySelector(`[data-more="${tabKey}"]`);
        const s = state[tabKey];

        const q = (searchInput?.value || '').toLowerCase().trim();
        const filtered = s.items.filter(it => (it.title || '').toLowerCase().includes(q));

        panel.innerHTML = filtered.length
          ? filtered.map(it => renderCard(it, tabKey)).join('')
          : `<div class="text-sm text-gray-500 p-6 text-center">Chưa có sản phẩm.</div>`;

        if (moreWrap) {
          if (s.page + 1 < s.totalPages) { moreWrap.classList.remove('hidden'); }
          else { moreWrap.classList.add('hidden'); }
        }

        // Cancel handlers
        panel.querySelectorAll('.btn-cancel').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const card = e.target.closest('.request-card');
            const id = card?.dataset.id;
            if (!id) return;
            if (!confirm('Bạn có chắc muốn hủy?')) return;
            const res = await csrfFetch(API.cancel(id), { method: 'POST' });
            if (res.ok) {
              s.items = s.items.filter(x => String(x.id) !== String(id));
              paintPanel(tabKey);
              loadCounts();
            } else {
              alert('Hủy thất bại!');
            }
          });
        });
        // === Save note handlers (chỉ xuất hiện ở tab đang-yeu-cau) ===
if (tabKey === 'dang-yeu-cau') {
  panel.querySelectorAll('.btn-save-note').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const card = e.target.closest('.request-card');
      const id = card?.dataset.id;
      if (!id) return;

      const textarea = card.querySelector('.note-input');
      const note = (textarea?.value || '').trim();

      try {
        const res = await csrfFetch(API.updateNote(id), {
          method: 'PATCH',
          body: JSON.stringify({ note })
        });
        if (!res.ok) {
          const text = await res.text().catch(()=> '');
          alert('Lưu ghi chú thất bại!' + (text ? ('\n' + text) : ''));
          return;
        }
        const updated = await res.json(); // DTO trả về
        // cập nhật item trong state
        const s = state[tabKey];
        const idx = s.items.findIndex(x => String(x.id) === String(id));
        if (idx >= 0) {
          s.items[idx].note = updated.note;
        }
        // re-render để đảm bảo đồng bộ
        paintPanel(tabKey);
        alert('Đã lưu ghi chú!');
      } catch (err) {
        console.error(err);
        alert('Không gọi được API lưu ghi chú');
      }
    });
  });
}

        // Rate open modal handlers
        panel.querySelectorAll('.btn-rate').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const card = e.target.closest('.request-card');
            openRateModal(card, tabKey);
          });
        });
      }

      // ===== Load counts =====
   async function loadCounts() {
  try {
    const res = await fetch(`/api/transactions/counts/mine?role=${FILTER_ROLE}`);
    if (res.ok) {
      const data = await res.json();
      ['REQUESTING','IN_PROGRESS','COMPLETED','CANCELLED'].forEach(k=>{
        document.getElementById(`count-${k}`).textContent = (data?.[k] ?? data?.[k.toLowerCase()] ?? 0);
      });
      return;
    } else {
      console.warn('[TX] counts API not ok:', res.status);
    }
  } catch (e) {
    console.warn('[TX] counts API error:', e);
  }

  // fallback từ state đã nạp 4 tab
  const calc = (status) => {
    const keys = ['dang-yeu-cau','dang-giao-dich','hoan-thanh','da-huy'];
    return keys.reduce((sum, key) => sum + state[key].items.filter(it => it.status === status).length, 0);
  };
  ['REQUESTING','IN_PROGRESS','COMPLETED','CANCELLED'].forEach(k=>{
    document.getElementById(`count-${k}`).textContent = calc(k);
  });
}



      // ===== Load tab =====
      async function loadTab(tabKey, append = false) {
  const s = state[tabKey];
  const status = tabMap[tabKey];

  if (!append) { s.page = 0; s.items = []; s.totalPages = 1; }

  try {
    const res = await fetch(API.list(status, s.page, s.size));
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const rawItems = Array.isArray(data) ? data : (data.items || data.content || []);
    const totalPages = (typeof data.totalPages === 'number')
      ? data.totalPages
      : (data.totalElements && data.size ? Math.ceil(data.totalElements / data.size) : 1);

    // build normalized
    const normalized = rawItems.map(it => ({
      id: it.id || it.transactionId || it.transaction_id || it.txId,
      title: it.title || it.productName || it.name || it.note || (it.details && it.details[0]?.product?.name) || 'Giao dịch',
      priceLabel: it.priceLabel || (it.totalAmount != null ? Number(it.totalAmount).toLocaleString('vi-VN') + 'đ' : null),
      thumbUrl: it.thumbUrl || it.imageUrl || it.thumbnail || (it.product && it.product.imageUrl) || (it.details && it.details[0]?.product?.imageUrl) || 'https://via.placeholder.com/160',
      ownerName: it.ownerName || it.sellerName || (it.seller && (it.seller.fullName || it.seller.name)) || '',
      note: it.note || '',
      createdAt: it.createdAt || it.created_at || it.createdDate || Date.now(),
      status: it.status || status,
      sellerId: it.sellerId || (it.seller && (it.seller.userId || it.seller.id)) || it.seller_id,
      buyerId: it.buyerId || (it.buyer && (it.buyer.userId || it.buyer.id)) || it.buyer_id
    }));

    // ⬇️ LỌC THEO VAI TRÒ
    let filtered = normalized;

// Nếu backend đã lọc theo ?role=BUYER rồi thì ta không cần lọc tiếp.
// Nhưng để an toàn: chỉ lọc khi có meId hợp lệ, còn không thì để nguyên.
if (hasMeId) {
  if (FILTER_ROLE === 'BUYER') {
    filtered = normalized.filter(it => Number(it.buyerId) === meId);
  } else if (FILTER_ROLE === 'SELLER') {
    filtered = normalized.filter(it => Number(it.sellerId) === meId);
  }
}


    // gán state
    s.totalPages = totalPages ?? 1;
    s.items = append ? s.items.concat(filtered) : filtered;

    // (phần ratedTxIds + paintPanel giữ nguyên)
    const txIds = s.items.map(x => x.id).filter(Boolean);
    if (txIds.length) {
      try {
        const q = encodeURIComponent(txIds.join(','));
        const res2 = await fetch(`/api/reviews/rated-by-me?txIds=${q}`);
        if (res2.ok) {
          const data2 = await res2.json();
          (data2.ratedTxIds || []).forEach(id => ratedTxIds.add(Number(id)));
        }
      } catch {}
    }

    paintPanel(tabKey);
  } catch (e) {
    console.error('loadTab error', e);
    const panel = document.querySelector(`[data-panel="${tabKey}"]`);
    panel.innerHTML = `<div class="text-sm text-red-500 p-6 text-center">Không tải được dữ liệu.</div>`;
  }
}


      // ===== Tabs =====
      const tabBtnsEls = document.querySelectorAll('.tab-btn');
      tabBtnsEls.forEach(btn => {
        btn.addEventListener('click', () => {
          tabBtnsEls.forEach(b => { b.classList.remove('text-red-600', 'border-red-500'); b.classList.add('text-gray-600', 'border-transparent'); });
          btn.classList.remove('text-gray-600', 'border-transparent');
          btn.classList.add('text-red-600', 'border-red-500');

          const name = btn.getAttribute('data-tab');
          activeTab = name;
          document.querySelectorAll('[data-panel]').forEach(p => p.classList.toggle('hidden', p.getAttribute('data-panel') !== name));
          document.querySelectorAll('[data-more]').forEach(m => m.classList.toggle('hidden', m.getAttribute('data-more') !== name));

          loadTab(name, false);
        });
      });

      // ===== Load more =====
      document.querySelectorAll('[data-more]').forEach(wrap => {
        const tabKey = wrap.getAttribute('data-more');
        const btn = wrap.querySelector('.load-more');
        btn?.addEventListener('click', () => {
          const s = state[tabKey];
          if (s.page + 1 < s.totalPages) {
            s.page += 1;
            loadTab(tabKey, true);
          }
        });
      });

      // ===== Search =====
      const onSearch = () => paintPanel(activeTab);
      searchInput?.addEventListener('input', onSearch);

      // ===== Rate modal =====
      const rateModal = document.getElementById('rateModal');
      const rateTitle = document.getElementById('rateTitle');
      const rateContent = document.getElementById('rateContent');
      const starWrap = document.getElementById('starWrap');
      const rateClose = document.getElementById('rateClose');
      const rateCancel = document.getElementById('rateCancel');
      const rateSave = document.getElementById('rateSave');

      let currentTxId = null;
      let currentRevieweeId = null;
      let currentStars = 5;

      function renderStars() {
        starWrap.innerHTML = '';
        for (let i = 1; i <= 5; i++) {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'w-9 h-9 flex items-center justify-center rounded-full hover:bg-gray-100';
          b.innerHTML = `<i class="fa-solid fa-star text-2xl ${i <= currentStars ? 'text-yellow-400' : 'text-gray-300'}"></i>`;
          b.addEventListener('click', () => { currentStars = i; renderStars(); });
          starWrap.appendChild(b);
        }
      }

      function openRateModal(cardEl, tabKey) {
        const s = state[tabKey];
        const txId = Number(cardEl?.dataset.id);
        const item = s.items.find(x => Number(x.id) === txId);
        if (!item) return;

        currentTxId = txId;
        currentStars = 5;
        rateContent.value = '';

        // xác định ai là người bị đánh giá
        const iAmSeller = (meId && item.sellerId && meId === Number(item.sellerId));
        currentRevieweeId = iAmSeller ? Number(item.buyerId) : Number(item.sellerId);

        const displayName = cardEl?.dataset.name || (iAmSeller ? 'Người mua' : 'Người bán');
        rateTitle.textContent = `Đánh giá: ${displayName}`;

        renderStars();
        rateModal.classList.remove('hidden');
        document.documentElement.classList.add('overflow-hidden');
        document.body.classList.add('overflow-hidden');
      }
      function closeRateModal() {
        rateModal.classList.add('hidden');
        document.documentElement.classList.remove('overflow-hidden');
        document.body.classList.remove('overflow-hidden');
      }
      rateClose.addEventListener('click', closeRateModal);
      rateCancel.addEventListener('click', closeRateModal);

      rateSave.addEventListener('click', async () => {
        console.log('rate click', { currentTxId, currentRevieweeId, currentStars, bodyText: rateContent.value });
        if (!currentTxId) { alert('Thiếu transactionId'); return; }
        if (!currentRevieweeId) { alert('Không xác định người được đánh giá'); return; }

        const body = { stars: currentStars, content: rateContent.value || '', ratedUserId: currentRevieweeId };
        try {
          const res = await csrfFetch(API.rate(currentTxId), { method: 'POST', body: JSON.stringify(body) });
          if (res.ok) {
            alert('Đã gửi đánh giá. Cảm ơn bạn!');
            ratedTxIds.add(Number(currentTxId));
            closeRateModal();
            paintPanel('hoan-thanh');
          } else {
            const text = await res.text().catch(() => '');
            alert('Gửi đánh giá thất bại!' + (text ? ('\n' + text) : ''));
          }
        } catch (e) {
          console.error(e);
          alert('Không gọi được API /rate');
        }
      });


      // ===== First load =====
      // ===== First load =====
(async () => {
  // nạp cả 4 tab (đều có role=BUYER trên URL)
  await Promise.all([
    loadTab('dang-yeu-cau', false),
    loadTab('dang-giao-dich', false),
    loadTab('hoan-thanh', false),
    loadTab('da-huy', false)
  ]);

  // hiển thị tab đầu tiên
  activeTab = 'dang-yeu-cau';
  document.querySelectorAll('[data-panel]').forEach(p => {
    p.classList.toggle('hidden', p.getAttribute('data-panel') !== activeTab);
  });
  document.querySelectorAll('[data-more]').forEach(m => {
    m.classList.toggle('hidden', m.getAttribute('data-more') !== activeTab);
  });

  // cuối cùng mới đếm
  await loadCounts();
})();

    })();
  </script>

    <script th:src="@{/js/favorite.js}"></script>
    
</body>

</html>