<!-- Header -->
<header th:fragment="headerGUEST" class="fixed top-0 left-0 w-full bg-red-600 text-white shadow-md z-50">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-4 py-2">

        <!-- Danh mục -->
        <div class="relative">
            <div class="flex items-center space-x-4">
                <button id="menuBtn" title="Danh mục"
                    class="w-8 h-8 flex items-center justify-center bg-white text-red-600 rounded-md shadow hover:bg-gray-200">
                    <img th:src="@{/image/header/menu.png}" alt="Menu" class="w-5 h-5" />
                </button>
                <a th:href="@{/StudentMarket}" class="text-xl font-extrabold transition">STUDENT MARKET</a>
            </div>

            <div id="menuDropdown"
                class="hidden absolute left-0 mt-4 w-72 bg-white text-gray-700 rounded-md shadow-lg z-40">

                <div th:each="p : ${categories}" class="relative group">
                    <a th:href="@{'/StudentMarket/category/parent/' + ${p.parentId}}"
                        class="w-full flex items-center justify-between px-4 py-2 hover:bg-gray-100 rounded-md">

                        <div class="flex items-center space-x-2">
                            <!-- Fallback nếu iconPath rỗng -->
                            <img th:if="${#strings.isEmpty(p.iconPath)}" th:src="@{/image/header/other.png}" alt="icon"
                                class="w-5 h-5" />

                            <!-- Có iconPath trong DB thì dùng -->
                            <img th:if="${!#strings.isEmpty(p.iconPath)}" th:src="${p.iconPath}" alt="icon"
                                class="w-5 h-5" />

                            <span th:text="${p.name}">Danh mục cha</span>
                        </div>

                        <!-- Ảnh mũi tên -->
                        <img th:src="@{/image/header/next.png}" alt="arrow" class="w-4 h-4" />
                    </a>

                    <div th:if="${!#lists.isEmpty(p.children)}"
                        class="absolute top-0 left-full ml-1 hidden group-hover:block bg-white text-gray-700 rounded-md shadow-lg"
                        style="width: 220px">
                        <a th:each="c : ${p.children}" th:href="@{'/StudentMarket/category/child/' + ${c.childId}}"
                            class="block px-4 py-2 hover:bg-gray-100 rounded-md" th:text="${c.name}">Danh mục
                            con</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Thanh Tìm kiếm -->
        <div class="flex-1 px-4 flex justify-center gap-2">
            <form th:action="@{/StudentMarket/SearchProduct}" method="get" class="flex w-full max-w-3xl" id="searchForm">
                <div class="relative flex-1">
                    <div class="flex items-center w-full bg-white rounded-lg shadow-sm">
                        <!-- Icon search -->
                        <span class="absolute left-2 text-gray-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1110.5 3a7.5 7.5 0 016.15 13.65z" />
                            </svg>
                        </span>

                        <!-- Input tìm kiếm -->
                        <input type="text" 
                               id="searchInput"
                               name="name"
                               placeholder="Tìm sản phẩm..."
                               th:value="${param.name}"
                               class="w-full px-4 py-2.5 pl-10 text-gray-800 placeholder-gray-400 rounded-lg appearance-none focus:outline-none border-none select-none"
                               style="-webkit-tap-highlight-color: transparent;"
                               onkeyup="showSuggestions(this, productSuggestions, 'productList')"
                               autocomplete="off" />

                        <!-- Divider -->
                        <div class="h-6 w-px bg-gray-300 mx-2"></div>

                        <!-- Location input -->
                        <div class="relative flex items-center min-w-[200px]">
                            <span class="text-gray-500 ml-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2C7.589 2 4 5.589 4 10c0 5.618 7.105 11.67 7.405 11.92a.998.998 0 001.19 0C12.895 21.67 20 15.618 20 10c0-4.411-3.589-8-8-8zm0 11c-1.654 0-3-1.346-3-3s1.346-3 3-3 3 1.346 3 3-1.346 3-3 3z"/>
                                </svg>
                            </span>
                            <div class="relative w-full">
                                <div class="flex items-center w-full cursor-pointer" onclick="toggleLocationDropdown()">
                                    <input type="text" 
                                           id="locationInput"
                                           name="location"
                                           placeholder="Khu vực"
                                           th:value="${param.location}"
                                           class="w-full px-3 py-2.5 rounded-r-lg text-gray-800 placeholder-gray-400 appearance-none focus:outline-none border-none cursor-pointer select-none"
                                        style="-webkit-tap-highlight-color: transparent;"
                                           readonly />
                                    <span class="absolute right-2 text-gray-400">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </span>
                                </div>
                                <div id="locationDropdown" class="hidden absolute right-0 mt-1 w-full bg-white border rounded-md shadow-lg max-h-60 overflow-auto z-50">
                                    <div class="py-1">
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-700"
                                             onclick="selectLocation(this.textContent)">
                                            Đà Nẵng
                                        </div>
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-700"
                                             onclick="selectLocation(this.textContent)">
                                            Hà Nội
                                        </div>
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-700"
                                             onclick="selectLocation(this.textContent)">
                                            Hồ Chí Minh
                                        </div>
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-700"
                                             onclick="selectLocation(this.textContent)">
                                            Quảng Nam
                                        </div>
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-700"
                                             onclick="selectLocation(this.textContent)">
                                            Hạ Long
                                        </div>
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-700"
                                             onclick="selectLocation(this.textContent)">
                                            Ninh Bình
                                        </div>
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-700"
                                             onclick="selectLocation(this.textContent)">
                                            Cần Thơ
                                        </div>
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-700"
                                             onclick="selectLocation(this.textContent)">
                                            Gia Lai
                                        </div>
                                        <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-700"
                                             onclick="selectLocation(this.textContent)">
                                            Vũng Tàu
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gợi ý sản phẩm -->
                    <ul id="productList" class="hidden absolute z-50 w-full mt-1 bg-white border rounded-md shadow-lg max-h-60 overflow-auto"></ul>

                    <!-- Gợi ý khu vực -->
                    <ul id="locationList" class="hidden absolute right-0 z-50 w-[200px] mt-1 bg-white border rounded-md shadow-lg max-h-60 overflow-auto"></ul>
                </div>
                
                <input type="hidden" name="childCategoryId" th:value="${activeChildId}" />
                <input type="hidden" name="size" th:value="${size != null ? size : 10}" />
            </form>

            <!-- Script xử lý gợi ý và nhấn Enter -->
            <script>
                // Xử lý dropdown location
                function toggleLocationDropdown() {
                    const dropdown = document.getElementById('locationDropdown');
                    dropdown.classList.toggle('hidden');
                }

                function selectLocation(value) {
                    const input = document.getElementById('locationInput');
                    input.value = value.trim(); // Thêm trim() để loại bỏ khoảng trắng thừa
                    document.getElementById('locationDropdown').classList.add('hidden');
                }

                // Đóng dropdown khi click ra ngoài
                document.addEventListener('click', function(e) {
                    const dropdown = document.getElementById('locationDropdown');
                    const locationInput = document.getElementById('locationInput');
                    const locationContainer = locationInput.closest('.relative'); // Sử dụng closest để tìm container
                    
                    if (!locationContainer.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                });

                // Thêm sự kiện click cho các item trong dropdown
                document.querySelectorAll('#locationDropdown .px-4.py-2').forEach(item => {
                    item.addEventListener('click', function() {
                        selectLocation(this.textContent);
                    });
                });

                // Lắng nghe sự kiện keypress trên toàn trang
                document.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        document.getElementById('searchForm').submit();
                    }
                });

                // Danh sách gợi ý sản phẩm
                const productSuggestions = [
                    "Giáo trình Toán cao cấp 1",
                    "Combo PDF Lý thuyết Mác - Lênin",
                    "Sách tiếng Anh TOEIC 600+ Hacker",
                    "Laptop HP 14 i5-8265U 8GB/256GB",
                    "Tai nghe Sony WH-CH510",
                    "Combo PDF Lý thuyết Mác - Lênin",
                    "Laptop HP 14 i5-8265U 8GB/256GB",
                    "Nồi cơm điện",
                    "Tai nghe",
                    "Màn hình ",
                    "Nồi cơm điện"
                ];

                // Danh sách gợi ý khu vực
                const locationSuggestions = [
                    "Đà Nẵng",
                    "Hà Nội",
                    "Hồ Chí Minh",
                    "Quảng Nam",
                    "Nam Định",
                    "Ninh Bình",
                    "Quang Ninh",
                    "Hải Phòng",
                    "Bắc Ninh"
                ];

                function showSuggestions(input, suggestions, listId) {
                    const list = document.getElementById(listId);
                    const value = input.value.toLowerCase();
                    
                    // Xóa gợi ý cũ
                    list.innerHTML = "";
                    
                    if (value === "") {
                        list.classList.add("hidden");
                        return;
                    }

                    // Lọc và hiển thị gợi ý
                    const matches = suggestions.filter(item => 
                        item.toLowerCase().includes(value)
                    );

                    if (matches.length > 0) {
                        matches.forEach(item => {
                            const li = document.createElement("li");
                            li.textContent = item;
                            li.className = "px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-700";
                            li.onclick = function() {
                                input.value = item;
                                list.classList.add("hidden");
                            };
                            list.appendChild(li);
                        });
                        list.classList.remove("hidden");
                    } else {
                        list.classList.add("hidden");
                    }
                }

                // Ẩn gợi ý khi click ngoài
                document.addEventListener("click", function(e) {
                    if (!e.target.matches("#searchInput") && !e.target.matches("#locationInput")) {
                        document.getElementById("productList").classList.add("hidden");
                        document.getElementById("locationList").classList.add("hidden");
                    }
                });

                // Xử lý nhấn Enter
                function handleEnter(event) {
                    if (event.key === "Enter") {
                        event.preventDefault();
                        document.getElementById("productList").classList.add("hidden");
                        document.getElementById("locationList").classList.add("hidden");
                        document.getElementById('searchForm').submit();
                    }
                }
            </script>
        </div>

        <!-- Icons + buttons Yêu thích với thông báo -->
        <div class="flex items-center space-x-3">
            <!-- Yêu thích -->
            <div class="relative">
                <button id="favBtn" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-500">
                    <img th:src="@{/image/header/like.png}" alt="Yêu Thích" class="w-6 h-6" />
                </button>
                <div id="favDropdown"
                    class="hidden absolute right-0 mt-4 w-56 bg-white text-gray-700 rounded-md shadow-lg z-40">
                    <p class="px-4 py-2 font-semibold border-b">Yêu thích</p>
                </div>
            </div>
            <!-- Thông báo -->
            <div class="relative">
                <button id="notiBtn" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-500">
                    <img th:src="@{/image/header/notification.png}" alt="Thông báo" class="w-6 h-6" />
                </button>
                <div id="notiDropdown"
                    class="hidden absolute right-0 mt-4 w-64 bg-white text-gray-700 rounded-md shadow-lg z-40">
                    <p class="px-4 py-2 font-semibold border-b">Thông báo</p>
                    <a href="#" class="block px-4 py-2 hover:bg-gray-100 hover:rounded-md">Nguyễn An đã nhắn bạn về
                        "Laptop cũ"</a>
                    <a href="#" class="block px-4 py-2 hover:bg-gray-100 hover:rounded-md">Sản phẩm "Xe đạp thể
                        thao" đã có người quan tâm</a>
                    <a href="#" class="block px-4 py-2 hover:bg-gray-100 hover:rounded-md">Bạn có 1 đánh giá mới</a>
                </div>
            </div>

            <!-- Đăng nhập -->
            <a th:href="@{/oauth2/authorization/google}"
                class="bg-white font-semibold text-black px-3 py-1 rounded-full flex items-center transition duration-200 ease-in-out hover:bg-gray-200"
                style="height: 36px; padding-bottom: 8px; padding-top: 8px;">
                Đăng nhập
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5 ml-2"
                    alt="Google" />
            </a>

            <!-- Avatar + dropdown -->
            <div class="relative">
                <button id="avatarBtn"
                    class="bg-red-500 p-2 rounded-full flex items-center space-x-1 hover:bg-red-400 relative overflow-visible">
                    <img th:src="@{/image/header/profile-user.png}" alt="Avatar"
                        class="w-7 h-7 rounded-full object-cover -m-1" />
                    <!-- Mũi tên dropdown avatar -->
                    <svg class="w-7 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 10 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                    </svg>
                </button>

                <!-- Dropdown menu -->
                <div id="dropdownMenu"
                    class="hidden absolute right-0 mt-3.5 w-72 bg-white rounded-xl shadow-lg z-50 overflow-hidden">
                    <!-- Header Dropdown menu -->
                    <div class="p-4">
                        <p class="text-sm text-black font-bold leading-snug">Đồ cũ trao tay, tiết kiệm mỗi ngày.</p>
                        <p class="text-gray-600 text-xs mt-1">Đăng nhập ngay!</p>

                        <!-- Button căn giữa -->
                        <div class="flex justify-center">
                            <a th:href="@{/oauth2/authorization/google}"
                                class="mt-3 bg-black font-semibold text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center">
                                Đăng nhập bằng
                                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
                                    class="w-5 h-5 ml-2" alt="Google" />
                            </a>

                        </div>
                    </div>

                    <!-- Footer Dropdown menu -->
                    <div class="border-t px-4 py-2 flex justify-center items-center text-xs font-medium bg-gray-200">
                        <a href="#" class="text-red-500">Tiếng Việt</a>
                        <span class="mx-1 text-gray-500">/</span>
                        <a href="#" class="text-gray-800 hover:text-black">English</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>