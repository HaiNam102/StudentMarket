<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />

    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Student Market - Website trao ƒë·ªïi v√† mua b√°n ƒë·ªì d√πng c≈© d√†nh cho sinh vi√™n DTU</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        .menu-parent:hover .menu-child {
            display: block;
        }
    </style>
</head>

<body class="bg-gray-100">
    <!-- Overlay n·ªÅn m·ªù -->
    <div id="overlay" class="hidden fixed inset-0 bg-black/50 z-40"></div>

    <!-- Header -->
    <div th:replace="~{fragments/headerUSER :: headerUSER}"></div>

    <!-- MAIN -->
    <main class="pt-14 pb-10">
        <div class="max-w-7xl mx-auto px-4 pt-9">

            <!-- Ph·∫ßn tr√™n: H·ªì s∆° (PROFILE) -->
            <div th:replace="~{fragments/hosoprofile :: hosoprofile}"></div>

            <!-- Layout 2 c·ªôt -->
            <div class="flex flex-col md:flex-row gap-6">

                <!-- Main Container -->
                <div class="flex flex-col md:flex-row gap-6">

                    <!-- Sidebar -->
                    <aside class="md:col-span-3">
                        <nav class="bg-white rounded-2xl shadow divide-y top-24 w-[245px]">

                            <a class="flex items-center gap-3 px-6 py-3 bg-red-50 rounded-tl-2xl rounded-tr-2xl"
                                th:href="@{/tongquan}">
                                <!-- Icon b·∫±ng ·∫£nh -->
                                <img src="image/thongtintaikhoan/home-red.png" alt="T·ªïng Quan"
                                    class="w-6 h-6 object-cover" />
                                <!-- N·ªôi dung -->
                                <span class="text-red-600 font-semibold">T·ªïng Quan</span>
                            </a>

                            <a class="flex items-center gap-3 px-6 py-3 hover:bg-gray-50"
                                th:href="@{/thongtintaikhoan}">
                                <!-- Icon b·∫±ng ·∫£nh -->
                                <img src="image/thongtintaikhoan/setting.png" alt="Th√¥ng tin t√†i kho·∫£n"
                                    class="w-6 h-6 object-cover" />
                                <!-- N·ªôi dung -->
                                <span class="text-gray-800 font-semibold">Th√¥ng tin t√†i kho·∫£n</span>
                            </a>

                            <a class="flex items-center gap-3 px-6 py-3 hover:bg-gray-50" th:href="@{/quanlybaidang}">
                                <!-- Icon b·∫±ng ·∫£nh -->
                                <img src="image/thongtintaikhoan/edit.png" alt="Qu·∫£n l√Ω b√†i ƒëƒÉng"
                                    class="w-6 h-6 object-cover" />
                                <!-- N·ªôi dung -->
                                <span class="text-gray-800 font-semibold">Qu·∫£n l√Ω b√†i ƒëƒÉng</span>
                            </a>

                            <a class="flex items-center gap-3 px-6 py-3 hover:bg-gray-50" th:href="@{/lichsugiaodich}">
                                <!-- Icon b·∫±ng ·∫£nh -->
                                <img src="image/thongtintaikhoan/file.png" alt="L·ªãch s·ª≠ giao d·ªãch"
                                    class="w-6 h-6 object-cover" />
                                <!-- N·ªôi dung -->
                                <span class="text-gray-800 font-semibold">L·ªãch s·ª≠ giao d·ªãch</span>
                            </a>

                            <a class="flex items-center gap-3 px-6 py-3 hover:bg-gray-50" th:href="@{/tichluydiem}">
                                <!-- Icon b·∫±ng ·∫£nh -->
                                <img src="image/thongtintaikhoan/tichluy.png" alt="T√≠ch l≈©y ƒëi·ªÉm"
                                    class="w-6 h-6 object-cover" />
                                <!-- N·ªôi dung -->
                                <span class="text-gray-800 font-semibold">T√≠ch l≈©y ƒëi·ªÉm</span>
                            </a>

                            <a class="flex items-center gap-3 px-6 py-3 hover:bg-gray-50" th:href="@{/danhgia}">
                                <!-- Icon b·∫±ng ·∫£nh -->
                                <img src="image/thongtintaikhoan/danhgia.png" alt="ƒê√°nh gi√°"
                                    class="w-6 h-6 object-cover" />
                                <!-- N·ªôi dung -->
                                <span class="text-gray-800 font-semibold">ƒê√°nh gi√°</span>
                            </a>

                            <a class="flex items-center gap-3 px-6 py-3 hover:bg-gray-50" th:href="@{/gopy}">
                                <!-- Icon b·∫±ng ·∫£nh -->
                                <img src="image/thongtintaikhoan/gopy.png" alt="G√≥p √Ω & h·ªó tr·ª£"
                                    class="w-6 h-6 object-cover" />
                                <!-- N·ªôi dung -->
                                <span class="text-gray-800 font-semibold">G√≥p √Ω & h·ªó tr·ª£</span>
                            </a>

                            <a class="flex items-center gap-3 px-6 py-3 hover:bg-gray-50" th:href="@{/dieukhoansudung}">
                                <!-- Icon b·∫±ng ·∫£nh -->
                                <img src="image/thongtintaikhoan/dieukhoan.png" alt="ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng"
                                    class="w-6 h-6 object-cover" />
                                <!-- N·ªôi dung -->
                                <span class="text-gray-800 font-semibold">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</span>
                            </a>

                            <form th:action="@{/logout}" method="post"
                                class="flex items-center gap-3 px-6 py-3 hover:bg-gray-50 rounded-bl-2xl rounded-br-2xl">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <button type="button"
                                    class="js-logout-trigger flex items-center gap-3 w-full text-left">
                                    <!-- Icon b·∫±ng ·∫£nh -->
                                    <img th:src="@{/image/thongtintaikhoan/dangxuat.png}" alt="ƒêƒÉng xu·∫•t"
                                        class="w-6 h-6 object-cover" />
                                    <!-- N·ªôi dung -->
                                    <span class="text-gray-800 font-semibold">ƒêƒÉng xu·∫•t</span>
                                </button>
                            </form>
                        </nav>
                    </aside>

                    <!-- ================== S·∫¢N PH·∫®M Y√äU TH√çCH ================== -->
                    <section class="flex-1 bg-white rounded-2xl shadow p-6" style="padding-top: 10px;">
                        <!-- Ti√™u ƒë·ªÅ -->
                        <div class="flex justify-center mb-6">
                            <div class="text-center">
                                <h3 class="text-red-600 font-bold">S·∫£n ph·∫©m y√™u th√≠ch</h3>
                                <div class="h-0.5 w-64 bg-red-500 mx-auto rounded-full mt-2"></div>
                            </div>
                        </div>

                        <!-- Grid s·∫£n ph·∫©m -->
                        <div id="productGrid" class="grid grid-cols-2 md:grid-cols-3 gap-6 mt-6" style="width: 931px;">
                            <!-- S·∫£n ph·∫©m y√™u th√≠ch t·ª´ database -->
                            <div th:each="product : ${favoriteProducts}"
                                class="product relative w-64 mx-auto bg-white border-2 rounded-lg shadow hover:shadow-lg transition transform hover:scale-105 p-2 cursor-pointer flex flex-col"
                                th:data-hot="${product.isHot}"
                                th:data-date="${#temporals.format(product.createdAt, 'yyyy-MM-dd')}"
                                th:data-price="${product.price}">
                                <div class="relative h-40 w-full">
                                    <img th:src="${product.imageUrl != null ? product.imageUrl : '/image/card/image.png'}"
                                        class="rounded-md w-full h-full object-cover" />

                                    <!-- N√∫t HOT -->
                                    <span th:if="${product.isHot}"
                                        class="absolute top-3 left-2 bg-black/80 text-white text-xs font-semibold px-2 py-1 rounded-full">Hot</span>

                                    <!-- Tr√°i tim -->
                                    <button th:onclick="'toggleFavorite(this, ' + ${product.productId} + ')'"
                                        th:data-product-id="${product.productId}"
                                        class="absolute top-2 right-2 w-8 h-8 flex items-center justify-center bg-white/80 backdrop-blur-sm rounded-full hover:scale-110 transition">
                                        <i class="fa-solid fa-heart" style="color: #ef4444;"></i>
                                    </button>
                                    <!-- Overlay ng√†y ƒëƒÉng + s·ªë ·∫£nh -->
                                    <div
                                        class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs px-2 py-1 flex justify-between items-center rounded-b-md">
                                        <span th:text="${product.relativeTime}">1 ng√†y tr∆∞·ªõc</span>
                                        <span class="flex items-center">
                                            <span
                                                th:text="${'+' + (product.images != null ? product.images.size() : 0)}">+3</span>
                                            <i class="fa-solid fa-image w-3 h-3 ml-2"></i>
                                        </span>
                                    </div>
                                </div>

                                <!-- N·ªôi dung -->
                                <div class="mt-2 text-sm flex flex-col flex-grow justify-between">
                                    <div>
                                        <p class="font-semibold text-base line-clamp-2 h-[48px] leading-6 overflow-hidden"
                                            th:text="${product.name}">T√™n s·∫£n ph·∫©m</p>
                                        <p class="text-gray-500 overflow-hidden text-ellipsis whitespace-nowrap block"
                                            th:text="${product.description}">M√¥ t·∫£</p>
                                        <div class="flex items-center text-gray-500 mt-1">
                                            <i class="fa-solid fa-location-dot text-gray-500 text-xs mr-1"></i>
                                            <p
                                                th:text="${product.address != null ? product.address.ward + ', ' + product.address.province : 'Ch∆∞a r√µ ƒë·ªãa ƒëi·ªÉm'}">
                                                ƒê·ªãa ƒëi·ªÉm</p>
                                        </div>
                                    </div>
                                    <p class="text-red-600 font-medium mt-1 text-lg"
                                        th:text="${product.price == 0 ? 'Mi·ªÖn ph√≠' : #numbers.formatDecimal(product.price, 0, 'COMMA', 3, 'POINT').replace(',', '.') + 'ƒë'}">
                                        0ƒë</p>
                                </div>
                            </div>

                            <!-- Th√¥ng b√°o n·∫øu kh√¥ng c√≥ s·∫£n ph·∫©m y√™u th√≠ch (lu√¥n t·ªìn t·∫°i, ·∫©n/hi·ªán b·∫±ng JS) -->
                            <div id="emptyState" class="col-span-full text-center py-12 hidden"
                                th:classappend="${#lists.isEmpty(favoriteProducts)} ? '' : ' hidden'">
                                <div class="text-gray-500">
                                    <i class="fa-regular fa-heart text-6xl mb-4"></i>
                                    <h3 class="text-xl font-semibold mb-2">Ch∆∞a c√≥ s·∫£n ph·∫©m y√™u th√≠ch</h3>
                                    <p class="text-sm">H√£y kh√°m ph√° v√† th√™m s·∫£n ph·∫©m v√†o y√™u th√≠ch nh√©!</p>
                                </div>
                            </div>

                        </div>

                        <!-- N√∫t xem th√™m (n·∫±m trong th·∫ª section ƒë·ªÉ k·∫ø th·ª´a padding/bg) -->
                        <div class="col-span-full mt-6 flex justify-center">
                            <button id="loadMoreBtn"
                                class="px-6 py-2 bg-white border border-gray-200 text-gray-800 font-medium rounded-md hover:bg-gray-50">
                                Xem th√™m
                            </button>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </main>

    <!-- Overlay cho modal -->
    <div id="modalOverlay" class="hidden fixed inset-0 bg-black/50 z-[9998]"></div>
    <!-- Modal x√°c nh·∫≠n ƒëƒÉng xu·∫•t -->
    <div th:replace="~{fragments/modallogout :: modallogout}"></div>

    <!-- FOOTER -->
    <div th:replace="~{fragments/footer :: footer}"></div>

    <script>
        // JS c·ªßa s·∫£n ph·∫©m
        let visibleCount = 6;              // hi·ªÉn th·ªã ban ƒë·∫ßu
        const step = 3;                    // s·ªë s·∫£n ph·∫©m m·ªói l·∫ßn b·∫•m "Xem th√™m"
        const grid = document.getElementById("productGrid");
        const loadMoreBtn = document.getElementById("loadMoreBtn");
        const emptyState = document.getElementById("emptyState");

        // L·∫•y danh s√°ch .product M·ªöI NH·∫§T, lo·∫°i tr·ª´ item ƒëang xo√°
        function getProducts() {
            return Array.from(grid.querySelectorAll(".product:not(.is-removing)"));
        }

        // Hi·ªÉn th·ªã/·∫©n tr·∫°ng th√°i r·ªóng + ƒëi·ªÅu ch·ªânh n√∫t "Xem th√™m"
        function updateEmptyState() {
            const items = getProducts();
            const hasItems = items.length > 0;

            if (emptyState) {
                emptyState.classList.toggle('hidden', hasItems); // kh√¥ng c√≤n s·∫£n ph·∫©m -> hi·ªán emptyState
            }
            if (loadMoreBtn) {
                // ch·ªâ hi·ªán "Xem th√™m" khi c√≤n item ·∫©n
                loadMoreBtn.style.display = (hasItems && visibleCount < items.length) ? "inline-block" : "none";
            }
        }

        // Hi·ªÉn th·ªã theo visibleCount (v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t)
        function showProducts() {
            const items = getProducts();
            items.forEach((p, i) => {
                p.style.display = i < visibleCount ? "block" : "none";
            });
            updateEmptyState(); // üëà c·∫≠p nh·∫≠t tr·∫°ng th√°i r·ªóng & n√∫t
        }

        // Sau khi xo√° 1 item: b·∫≠t th√™m item ƒëang ·∫©n ƒë·ªÉ ƒë·ªß visibleCount
        function refillAfterRemove() {
            const items = getProducts();
            const shouldShow = Math.min(visibleCount, items.length);

            // ƒê·∫øm s·ªë item ƒëang hi·ªÉn th·ªã
            let currentlyVisible = 0;
            for (const p of items) if (p.style.display !== "none") currentlyVisible++;

            // B·∫≠t th√™m n·∫øu thi·∫øu
            let need = shouldShow - currentlyVisible;
            if (need > 0) {
                for (const p of items) {
                    if (need <= 0) break;
                    if (p.style.display === "none") {
                        p.style.display = "block";
                        need--;
                    }
                }
            }

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i r·ªóng + n√∫t
            updateEmptyState(); // üëà n·∫øu ƒë√£ xo√° h·∫øt ‚Üí hi·ªán emptyState ngay
        }

        // Cho favorite.js d√πng
        window.showProducts = showProducts;
        window.refillAfterRemove = refillAfterRemove;

        // N√∫t "Xem th√™m"
        if (loadMoreBtn) {
            loadMoreBtn.addEventListener("click", () => {
                visibleCount += step;
                showProducts();
            });
        }

        // Kh·ªüi t·∫°o
        showProducts();

        // JS x·ª≠ l√Ω ƒëƒÉng xu·∫•t
        (() => {
            const overlay = document.getElementById('modalOverlay');
            const modal = document.getElementById('logoutConfirm');
            const btnOK = document.getElementById('logoutSubmit');
            const btnNO = document.getElementById('logoutCancel');

            let targetForm = null; // form s·∫Ω ƒë∆∞·ª£c submit khi b·∫•m "C√≥"

            function openModal(form) {
                targetForm = form;
                overlay.classList.remove('hidden');
                modal.classList.remove('hidden');
            }
            function closeModal() {
                overlay.classList.add('hidden');
                modal.classList.add('hidden');
                targetForm = null;
            }

            // B·∫Øt c√°c n√∫t logout
            document.querySelectorAll('.js-logout-trigger').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const form = btn.closest('form');
                    if (!form) return;
                    openModal(form);
                });
            });

            // N√∫t "Kh√¥ng"
            btnNO.addEventListener('click', (e) => {
                e.preventDefault();
                closeModal();
            });

            // N√∫t "C√≥"
            btnOK.addEventListener('click', (e) => {
                e.preventDefault();
                if (targetForm) {
                    // tr√°nh submit ƒë√¥i
                    btnOK.disabled = true;
                    targetForm.submit();
                } else {
                    closeModal();
                }
            });

            // Click ra ngo√†i h·ªôp => ƒë√≥ng
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            overlay.addEventListener('click', closeModal);
        })();

        // H√†m l·∫•y CSRF token
        function getCSRFToken() {
            const csrfToken = document.querySelector('meta[name="_csrf"]');
            if (csrfToken) {
                return '_csrf=' + encodeURIComponent(csrfToken.getAttribute('content'));
            }
            return '';
        }
    </script>

    <!-- JS c·ªßa ph·∫ßn Header -->
    <script>
        const overlay = document.getElementById('overlay');
        const dropdowns = {
            menuBtn: 'menuDropdown',
            favBtn: 'favDropdown',
            notiBtn: 'notiDropdown',
            avatarBtn: 'dropdownMenu'
        };

        Object.entries(dropdowns).forEach(([btnId, menuId]) => {
            const btn = document.getElementById(btnId);
            const menu = document.getElementById(menuId);

            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = !menu.classList.contains('hidden');

                Object.values(dropdowns).forEach(id =>
                    document.getElementById(id).classList.add('hidden')
                );

                if (isOpen) {
                    menu.classList.add('hidden');
                    overlay.classList.add('hidden');
                } else {
                    menu.classList.remove('hidden');
                    overlay.classList.remove('hidden');
                }
            });
        });

        overlay.addEventListener('click', () => {
            overlay.classList.add('hidden');
            Object.values(dropdowns).forEach(id =>
                document.getElementById(id).classList.add('hidden')
            );
        });

        document.addEventListener('click', (e) => {
            if (!Object.keys(dropdowns).some(btnId =>
                document.getElementById(btnId).contains(e.target)
            )) {
                overlay.classList.add('hidden');
                Object.values(dropdowns).forEach(id =>
                    document.getElementById(id).classList.add('hidden')
                );
            }
        });
    </script>

    <script th:src="@{/js/favorite.js}"></script>

</body>

</html>